# ๐ ุชุตุญูุญ ูุดููุฉ ุงูุฃูุงู ูู ุนูููุฉ ุงูุฏูุน

## ุงููุดููุฉ ุงูููุชุดูุฉ ๐จ
ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ุจุงูุฏูุน ูุนููุงู ูุฑุฌุน ุฅูู ุตูุญุฉ `/subscription/success`ุ ูุงู ูุฑู ุฑุณุงูุฉ "ุชู ุงูุฏูุน ุจูุฌุงุญ" ุจุฏูู ุงูุชุญูู ุงููุนูู ูู ุญุงูุฉ ุงูุฏูุน.

### ุณุจุจ ุงููุดููุฉ:
```
โ ุตูุญุฉ ุงููุฌุงุญ ูุงูุช ุชุนุฑุถ ุฑุณุงูุฉ ุงููุฌุงุญ ููุท ุจูุงุกู ุนูู ูุตูู ุงููุณุชุฎุฏู ููุตูุญุฉ
โ ูุง ุชุชุญูู ูู ุญุงูุฉ ุงูุงุดุชุฑุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ ุญุชู ูู ูุดู ุงูุฏูุนุ ูููู ุงููุณุชุฎุฏู ุฃู ูุนูุฏ ููุฑุงุจุท ููุฑู ุงููุฌุงุญ
```

## ุงูุญู ุงููุทุจู โ

### 1. ุชุนุฏูู ุตูุญุฉ `/subscription/success/page.tsx`

#### ุงูุฌุฏูุฏ: ุงูุชุญูู ูู ุญุงูุฉ ุงูุฏูุน
```typescript
// ูุจู ุนุฑุถ ุฑุณุงูุฉ ุงููุฌุงุญุ ูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
const checkPaymentStatus = async () => {
  // ุงูุจุญุซ ุนู ุงูุงุดุชุฑุงู ุจูุงุกู ุนูู store_id ู payment_reference
  const { data: subscription } = await supabase
    .from("subscriptions")
    .select("status, payment_reference, store_id")
    .eq("store_id", storeId)
    .eq("payment_reference", orderId)
    .single()

  // ุงูุชุญูู ูู ุงูุญุงูุฉ:
  // โ active = ุชู ุชูุนูู ุงูุงุดุชุฑุงูุ ุนุฑุถ ุงููุฌุงุญ
  // โณ pending = ุฌุงุฑู ุงููุนุงูุฌุฉุ ุงูุชุธุฑ ุงูุชุญุฏูุซ
  // โ failed = ูุดู ุงูุฏูุนุ ุฃุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ
}
```

#### ุงูุญุงูุงุช ุงูุชู ูุชู ุนุฑุถูุง:
1. **โณ ููุฏ ุงููุนุงูุฌุฉ (Pending)**: ุนูุฏูุง ูู ูุชู ุชุฃููุฏ ุงูุฏูุน ุจุนุฏ
   - ุฑุณุงูุฉ: "ุฌุงุฑู ูุนุงูุฌุฉ ุงูุฏูุน... ูุฏ ูุณุชุบุฑู ุจุถุน ุซูุงูู"
   - ุฒุฑ: "ุชุญุฏูุซ ุงูุญุงูุฉ"
   - ุชุญุฏูุซ ุชููุงุฆู ูู 2 ุซุงููุฉ

2. **โ ูุฌุญ (Active)**: ุนูุฏูุง ุชู ุชุฃููุฏ ุงูุฏูุน ุจูุงุณุทุฉ webhook
   - ุฑุณุงูุฉ: "ุชู ุงูุฏูุน ุจูุฌุงุญ! ๐"
   - ุนุฑุถ ุจูุงูุงุช ุงููุชุฌุฑ
   - ุฃุฒุฑุงุฑ: ุงูุชุญ ููุญุฉ ุงูุชุญูู / ูุนุงููุฉ ุงููุชุฌุฑ

3. **โ ูุดู (Failed)**: ุนูุฏูุง ูุดู ุงูุฏูุน
   - ุฑุณุงูุฉ: "ูุดู ุงูุฏูุน. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู"
   - ุฒุฑ: ุงูุนูุฏุฉ ูุฅูุดุงุก ูุชุฌุฑ ุฌุฏูุฏ

4. **โ ุบูุฑ ูุนุฑูู (Unknown)**: ุฎุทุฃ ูู ุงููุธุงู
   - ุฑุณุงูุฉ: "ุชุนุฐุฑ ุงูุชุญูู ูู ุงูุฏูุน"
   - ุฒุฑ: ุชุญุฏูุซ ุงูุญุงูุฉ

### 2. ุณูุฑ ุงูุนูู ุงููุงูู ููุฏูุน

```mermaid
graph TD
    A[ุงููุณุชุฎุฏู ูููุฑ ุนูู 'ูุชุงุจุนุฉ ููุฏูุน'] --> B[ุฅูุดุงุก ุทูุจ ุฏูุน ุจุญุงูุฉ pending]
    B --> C[ุชูุฌูู ูุตูุญุฉ Kashier]
    C --> D{ูุฏูุน ุงููุณุชุฎุฏูุ}
    D -->|ูุนู| E[Kashier ูุฑุณู webhook]
    D -->|ูุง| F[ูุถุบุท ุงูุฒุฑ ุงูุฎููู]
    E --> G[ุชุญุฏูุซ ุญุงูุฉ ุงูุงุดุชุฑุงู ุฅูู active]
    F --> H[ูุฐูุจ ููุตูุญุฉ success]
    G --> I[ุตูุญุฉ success ุชุนุฑุถ ุงููุฌุงุญ]
    H --> J[ุตูุญุฉ success ุชุชุญูู ูู ุงูุญุงูุฉ]
    J --> K[ุงูุญุงูุฉ pending - ุนุฑุถ ุงูุชุธุงุฑ]
```

### 3. ูููุงุช ูุนุฏูุฉ

#### `src/app/subscription/success/page.tsx`
- โ ุฅุถุงูุฉ `checkPaymentStatus()` ููุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฅุถุงูุฉ ูุชุบูุฑ `paymentStatus` ููุชุชุจุน
- โ ุนุฑุถ ุญุงูุงุช ูุฎุชููุฉ ุญุณุจ ูุชูุฌุฉ ุงูุฏูุน
- โ ุชุญุฏูุซ ุชููุงุฆู ููุญุงูุฉ ุงููุนููุฉ

#### `src/app/api/payment/subscription/webhook/route.ts`
- โ ููุฌูุฏ ุจุงููุนู ููุนูู ุจุดูู ุตุญูุญ
- โ ูุชุญูู ูู ุงูุชูููุน (Signature)
- โ ูุญุฏุซ ุญุงูุฉ ุงูุงุดุชุฑุงู ุฅูู `active` ุนูุฏ ูุฌุงุญ ุงูุฏูุน

#### `src/app/api/payment/subscription/initiate/route.ts`
- โ ููุฌูุฏ ุจุงููุนู
- โ ููุดุฆ ุงุดุชุฑุงู ุจุญุงูุฉ `pending` ุฃููุงู
- โ ูุฑุณู ุงููุณุชุฎุฏู ุฅูู Kashier ููุฏูุน

### 4. ููููุฉ ุงุฎุชุจุงุฑ ุงูุญู

#### ุงูุณููุงุฑูู 1: โ ุงูุฏูุน ุงููุงุฌุญ
```bash
1. ูู ุจุฅูุดุงุก ูุชุฌุฑ ุฌุฏูุฏ
2. ูู ุตูุญุฉ ุงุฎุชูุงุฑ ุงูุจุงูุฉุ ุงููุฑ "ุงููุชุงุจุนุฉ ููุฏูุน"
3. ูู Kashierุ ุฃููู ุนูููุฉ ุงูุฏูุน ุจูุฌุงุญ
4. ุณุชุธูุฑ ุตูุญุฉ ุงููุฌุงุญ ูุน "ุชู ุงูุฏูุน ุจูุฌุงุญ! ๐"
5. ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: subscriptions.status = "active"
```

#### ุงูุณููุงุฑูู 2: โ ุงูุฏูุน ุงููุฑููุถ
```bash
1. ูู ุจุฅูุดุงุก ูุชุฌุฑ ุฌุฏูุฏ
2. ูู ุตูุญุฉ ุงุฎุชูุงุฑ ุงูุจุงูุฉุ ุงููุฑ "ุงููุชุงุจุนุฉ ููุฏูุน"
3. ูู Kashierุ ุงุถุบุท "ุฅูุบุงุก" ุฃู ุฃุฑุฌุน ุงูุจุทุงูุฉ
4. ุณุชุธูุฑ ุตูุญุฉ ุงูุฅูุบุงุก
5. ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: subscriptions.status = "failed"
```

#### ุงูุณููุงุฑูู 3: ๐ ุฅุฑุฌุงุน ูุฏูู ูู Kashier (ุงูุญุงูุฉ ุงูุฎุทูุฑุฉ)
```bash
1. ูู ุจุฅูุดุงุก ูุชุฌุฑ ุฌุฏูุฏ
2. ูู ุตูุญุฉ ุงุฎุชูุงุฑ ุงูุจุงูุฉุ ุงููุฑ "ุงููุชุงุจุนุฉ ููุฏูุน"
3. ูู Kashierุ ุฃุบูู ุงูุชุงุจ ุจุฏูู ุฅููุงู
4. ุงูุชุจ ุงูุฑุงุจุท ูุฏูููุง: yourapp.com/subscription/success?store_id=X&orderId=Y
5. ุณุชุธูุฑ ุฑุณุงูุฉ "ุฌุงุฑู ูุนุงูุฌุฉ ุงูุฏูุน... โณ"
6. ูุง ุชุธูุฑ ุฑุณุงูุฉ ุงููุฌุงุญ ุญุชู ูุชู ุชุฃููุฏ ุงูุฏูุน ูุนูุงู
```

### 5. ุงูุญูุงูุฉ ุงููุถุงูุฉ

| ุงูุญุงูุฉ | ุงููุจู | ุงูุขู |
|--------|-------|------|
| ุฏุฎูู ูุฏูู ูุฑุงุจุท ุงููุฌุงุญ ุจุฏูู ุฏูุน | โ ูุฑู ูุฌุงุญ | โ ุฑุณุงูุฉ ุงูุชุธุงุฑ |
| ูุดู ุงูุฏูุน ูู Kashier | โ ูุฏ ูุฑู ูุฌุงุญ | โ ุฑุณุงูุฉ ูุดู |
| ุชุฃุฎุฑ ูุนุงูุฌุฉ webhook | โ ููุฑุงู ูุฌุงุญ | โ ุงูุชุธุงุฑ ูุน ุชุญุฏูุซ |
| ุงูุงุดุชุฑุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช | - | โ ุชุญูู ุฏุงุฆูุงู |

### 6. ุงูุฎุทูุท ุงูุฒูููุฉ

```
ุงูุขู:
T=0s  โ ุงููุณุชุฎุฏู ูููุฑ "ูุชุงุจุนุฉ ููุฏูุน"
T=1s  โ ููุดุฆ ุงุดุชุฑุงู ุจุญุงูุฉ pending
T=2s  โ ูุฐูุจ ููุฏูุน ูู Kashier
T=10s โ ูููุฑ ุงูุฏูุน ุจูุฌุงุญ
T=11s โ Kashier ูุฑุณู webhook
T=12s โ webhook ูุญุฏุซ ุงูุญุงูุฉ ุฅูู active
T=15s โ ุตูุญุฉ ุงููุฌุงุญ ุชุนุฑุถ ุงููุฌุงุญ โ
```

### 7. ูุชุทูุจุงุช ุงูุฃูุงู ุงููุณุชูุจูู

1. **ุงูุชุญูู ูู ุงูุชูููุน** โ ููุฌูุฏ
   ```typescript
   verifyKashierWebhookSignature(rawBody, signature, timestamp)
   ```

2. **ุชุฃููุฏ ุงูุจูุงูุงุช** โ ููุฌูุฏ
   ```typescript
   // ุงูุชุญูู ูู:
   // - order_id ููุฌูุฏ
   // - amount ุตุญูุญ
   // - currency ุตุญูุญ
   ```

3. **ุณุฌูุงุช ุงูุฃูุงู** โ ููุฌูุฏ
   ```typescript
   // ุชุณุฌูู ุฌููุน ุงูุฃุญุฏุงุซ ูู payment_webhooks ู payment_transactions
   ```

## ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

โ **ุงููุธุงู ุงูุขู ุขูู ุชูุงูุงู:**
- ูุง ูููู ุงูุงุฏุนุงุก ุจุงูุฏูุน ุจุฏูู ุงูุชุญูู ุงููุนูู
- ุฌููุน ุงูุชุญุฏูุซุงุช ุชุฃุชู ูู webhook ุงูููุซูู
- ูุงุฌูุฉ ุงููุณุชุฎุฏู ุชุนูุณ ุงูุญุงูุฉ ุงูุญููููุฉ
