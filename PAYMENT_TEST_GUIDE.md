# ๐งช ุงุฎุชุจุงุฑ ุญู ุฃูุงู ุงูุฏูุน

## ุฎุทุฉ ุงูุงุฎุชุจุงุฑ ุงูุดุงููุฉ

### 1๏ธโฃ **ุงุฎุชุจุงุฑ ุงูุฏูุน ุงููุงุฌุญ**

#### ุงูุฎุทูุงุช:
```
1. ุงูุชูู ุฅูู /create-store
2. ููุฃ ุจูุงูุงุช ุงููุชุฌุฑ:
   - ุงุณู ุงููุชุฌุฑ: "ูุชุฌุฑ ุงูุงุฎุชุจุงุฑ"
   - ุงูุฏูููู (Subdomain): "test-store"
   - ุงููุงุชู: "0123456789"
   - ุงููุตู: "ูุชุฌุฑ ุชุฌุฑูุจู"
3. ุงููุฑ "ุงูุชุงูู - ุงุฎุชูุงุฑ ุงูุจุงูุฉ"
4. ุงุฎุชุฑ ุฃู ุจุงูุฉ ุบูุฑ ูุฌุงูู (ูุซู ุงูุดูุฑู 5 ุฌููู)
5. ุงููุฑ "ุงููุชุงุจุนุฉ ููุฏูุน"
6. ูู ุตูุญุฉ Kashier (ุงูุฏูุน):
   - ุงุณุชุฎุฏู ุจูุงูุงุช ุงุฎุชุจุงุฑ Kashier
   - ุฃููู ุนูููุฉ ุงูุฏูุน ุจูุฌุงุญ
7. ุณุชุธูุฑ ุตูุญุฉ /subscription/success
```

#### ุงูุชุญูู:
```
โ ุชุญูู ูู ุธููุฑ ุฑุณุงูุฉ "ุชู ุงูุฏูุน ุจูุฌุงุญ! ๐"
โ ุชุญูู ูู ุนุฑุถ ุจูุงูุงุช ุงููุชุฌุฑ
โ ุชุญูู ูู ูุฌูุฏ ุงูุฃุฒุฑุงุฑ:
   - "ุงูุชุญ ููุญุฉ ุงูุชุญูู"
   - "ูุนุงููุฉ ุงููุชุฌุฑ"
โ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
   - subscriptions.status = "active"
   - subscriptions.start_date โ null
   - subscriptions.end_date โ null
```

---

### 2๏ธโฃ **ุงุฎุชุจุงุฑ ุงูุฏูุน ุงููุฑููุถ (ูู Kashier)**

#### ุงูุฎุทูุงุช:
```
1. ูุฑุฑ ููุณ ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ ุงูุณุงุจู (1-5)
2. ูู ุตูุญุฉ Kashier:
   - ุงุณุชุฎุฏู ุจุทุงูุฉ ุฑูุถ ุงูุงุฎุชุจุงุฑ (Testing Card)
   - ุฃู ุงููุฑ ุฒุฑ ุงูุฅูุบุงุก
3. ุณูุชู ุชูุฌููู ูุตูุญุฉ /subscription/cancel
```

#### ุงูุชุญูู:
```
โ ุชุญูู ูู ุธููุฑ ุฑุณุงูุฉ "ุชู ุฅูุบุงุก ุนูููุฉ ุงูุฏูุน"
โ ุชุญูู ูู ุงูุฑุณุงูุฉ: "ูู ูุชู ุฎุตู ุฃู ูุจูุบ"
โ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
   - subscriptions.status = "failed"
```

---

### 3๏ธโฃ **ุงุฎุชุจุงุฑ ุงูุฏูุน ุงููุนูู - ุงูุญุงูุฉ ุงูุฎุทูุฑุฉ โ๏ธ**

ูุฐุง ูู ุงูุณููุงุฑูู ุงูุฎุทูุฑ! ุฅุฐุง ุฑุฌุน ุงููุณุชุฎุฏู ุจุฏูู ุฅููุงู ุงูุฏูุน ุฃู ุญุชู ุจุฏูู ุงูุฐูุงุจ ูู Kashier.

#### ุงูุณููุงุฑูู A: ุงูุฅุบูุงู ุงูุชููุงุฆู ูููุงูุฐุฉ

```
1. ุงูุชูู ุฅูู /create-store
2. ูุฑุฑ ุงูุฎุทูุงุช ุญุชู ุชุธูุฑ ุตูุญุฉ ุงูุฏูุน Kashier
3. (ูุง ุชูุนู ุดูุกุ ููุท ุฃุบูู ุงูุชุงุจ ุฃู ุงููุงูุฐุฉ)
4. ุงูุชุจ ุงูุฑุงุจุท ูุฏูููุง ูู ุงููุชุตูุญ:
   https://yourapp.com/subscription/success?store_id=ABC&orderId=SUB-ABC-123
```

#### ุงูุณููุงุฑูู B: ุงูุฑุฌูุน ูู ูุชุตูุญ

```
1. ุงูุชูู ุฅูู ุตูุญุฉ ุงูุฏูุน Kashier
2. ุงููุฑ ุงูุฒุฑ ุงูุฎููู (Back) ุจุณุฑุนุฉ
3. ูุฏ ุชุตู ูุตูุญุฉ /subscription/success
```

#### ุงูุชุญูู (ุงูููู ุฌุฏุงู!) ๐ด

**ูุจู ุงูุชุตุญูุญ (ุงูุฎุทุฃ):**
```
โ ุชุธูุฑ ุฑุณุงูุฉ "ุชู ุงูุฏูุน ุจูุฌุงุญ! ๐"
โ ูุฑู ุฃุฒุฑุงุฑ "ุงูุชุญ ููุญุฉ ุงูุชุญูู" ู "ูุนุงููุฉ ุงููุชุฌุฑ"
โ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: subscriptions.status = "pending" (ูู ูุชุบูุฑ!)
๐ด ูุดููุฉ ุฃูููุฉ: ูุนุชูุฏ ุงููุณุชุฎุฏู ุฃูู ุฏูุน ุจุฏูู ุฃู ููุนู!
```

**ุจุนุฏ ุงูุชุตุญูุญ (ุงูุตุญูุญ):**
```
โ ุชุธูุฑ ุฑุณุงูุฉ "ุฌุงุฑู ูุนุงูุฌุฉ ุงูุฏูุน... โณ"
โ ูุฑู ุฑุณุงูุฉ: "ูุฏ ูุณุชุบุฑู ุจุถุน ุซูุงูู. ูุฑุฌู ุนุฏู ูุบุงุฏุฑุฉ ุงูุตูุญุฉ"
โ ูุฑู ุฒุฑ "ุชุญุฏูุซ ุงูุญุงูุฉ"
โ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: subscriptions.status = "pending" (ูู ูุชุบูุฑ)
โ ุงูุตูุญุฉ ุชุญุฏูุซ ุชููุงุฆูุงู ูู 2 ุซุงููุฉ
โ ุฅุฐุง ููุท ุฐูุจ ููุฏูุน ูุฃูููุ ุณุชุธูุฑ ุฑุณุงูุฉ ุงููุฌุงุญ
๐ ุขูู ุชูุงูุงู: ูุง ูููู ุงูุงุฏุนุงุก ุจุงูุฏูุน ุจุฏูู ุชุฃููุฏ ูุนูู
```

---

### 4๏ธโฃ **ุงุฎุชุจุงุฑ ุชุฃุฎุฑ Webhook (ุงููุนุงูุฌุฉ ุงูุจุทูุฆุฉ)**

ูู ุจุนุถ ุงูุญุงูุงุชุ ูุฏ ูุณุชุบุฑู webhook ูู Kashier ุฏูุงุฆู ูููุตูู.

#### ุงูุฎุทูุงุช:
```
1. ูุฑุฑ ุงุฎุชุจุงุฑ ุงูุฏูุน ุงููุงุฌุญ
2. ููู ุชููู ุนูุฏ ูุฑุงูุจุฉ logs
3. ูุฏ ุชุฑู ุงูุขุชู:
   - T=0s: ุงููุณุชุฎุฏู ูุฏูุน ุจูุฌุงุญ ูู Kashier
   - T=0.5s: ูุชู ุชูุฌููู ููุตูุญุฉ success
   - T=0.5s: ุชุธูุฑ ุฑุณุงูุฉ "ุฌุงุฑู ูุนุงูุฌุฉ ุงูุฏูุน... โณ"
   - T=5s: ูุตู webhook ูู Kashier
   - T=6s: ุชุญุฏูุซ ุงูุญุงูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - T=7s: ุตูุญุฉ success ุชุนุฑุถ ุฑุณุงูุฉ ุงููุฌุงุญ
```

#### ุงูุชุญูู:
```
โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูู ุงูู console
โ ุงูุฑุณุงูุฉ ุชุชุบูุฑ ูู "ุฌุงุฑู ุงููุนุงูุฌุฉ" ุฅูู "ุชู ุจูุฌุงุญ"
โ ุงูุฃุฒุฑุงุฑ ุชุธูุฑ ุจุฏูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
โ ูู Database logs: webhook ุฏุฎู ููุฌุญ
```

---

### 5๏ธโฃ **ุงุฎุชุจุงุฑ ุงูุงุดุชุฑุงู ุงููุฌุงูู**

ูุฐุง ูุง ูุชุทูุจ ุฏูุนุ ููุฌุจ ุฃู ููุชูู ูุจุงุดุฑุฉ.

#### ุงูุฎุทูุงุช:
```
1. ุงูุชูู ุฅูู /create-store
2. ููุฃ ุจูุงูุงุช ุงููุชุฌุฑ
3. ุงุฎุชุฑ ุงูุจุงูุฉ ุงููุฌุงููุฉ
4. ุงููุฑ "ุฅูุดุงุก ุงููุชุฌุฑ" (ุจุฏูู "ุงููุชุงุจุนุฉ ููุฏูุน")
5. ุณูุชู ุชูุฌููู ูุจุงุดุฑุฉ ููู admin
```

#### ุงูุชุญูู:
```
โ ูุง ุชุธูุฑ ุตูุญุฉ ุงูุฏูุน
โ ูุชู ุงูุชูุฌูู ูุจุงุดุฑุฉ ุฅูู /admin
โ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
   - subscriptions.status = "active"
   - subscriptions.start_date = ุชูููุช ุงูุขู
```

---

## ๐ ุฌุฏูู ุงูุงุฎุชุจุงุฑ

| # | ุงูุญุงูุฉ | ุงูุฎุทูุงุช | ุงููุชูุฌุฉ ุงููุชููุนุฉ | ุงูุญุงูุฉ ูู DB |
|---|--------|--------|------------------|--------------|
| 1 | โ ูุฌุญ | ุฅููุงู ุงูุฏูุน | "ุชู ุงูุฏูุน ุจูุฌุงุญ!" | active |
| 2 | โ ูุดู | ุฅูุบุงุก ุงูุฏูุน | "ุชู ุฅูุบุงุก ุงูุนูููุฉ" | failed |
| 3 | โณ ูุนูู | ุนุฏู ุงูุชุฃููุฏ | "ุฌุงุฑู ุงููุนุงูุฌุฉ" | pending |
| 4 | ๐ ุชุฃุฎุฑ | ุชุฃุฎุฑ webhook | ุชุญุฏูุซ ุชููุงุฆู | pendingโactive |
| 5 | ๐ ูุฌุงูู | ูุง ุฏูุน | ุชูุฌูู ูุจุงุดุฑ | active |

---

## ๐ ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงุณุชุนูุงู ููุชุญูู ูู ุญุงูุฉ ุงูุฏูุน:

```sql
-- ุชุญูู ูู ุขุฎุฑ ุงุดุชุฑุงู ูููุณุชุฎุฏู
SELECT 
  s.id,
  s.store_id,
  s.status,
  s.payment_reference,
  s.start_date,
  s.end_date,
  p.name,
  p.price
FROM subscriptions s
LEFT JOIN subscription_plans p ON s.plan_id = p.id
WHERE s.store_id = 'STORE_ID_HERE'
ORDER BY s.created_at DESC
LIMIT 1;
```

### ูุญุต logs ุงูู webhook:

```sql
-- ุชุญูู ูู webhook events
SELECT 
  id,
  source,
  event_type,
  signature_verified,
  status,
  created_at
FROM payment_webhooks
WHERE payload->>'order_id' = 'ORDER_ID_HERE'
ORDER BY created_at DESC;
```

---

## ๐ ุฃุชูุชุฉ ุงูุงุฎุชุจุงุฑ (ุงุฎุชูุงุฑู)

ุฅุฐุง ุฃุฑุฏุช ุฃู ุชุฎุชุจุฑ ุชููุงุฆูุงู ุจุงุณุชุฎุฏุงู curl:

```bash
# 1. ุฅูุดุงุก ูุชุฌุฑ
curl -X POST http://localhost:3000/api/stores/create \
  -H "Content-Type: application/json" \
  -d '{
    "store_name": "Test Store",
    "subdomain": "test-auto-1",
    "phone": "0123456789",
    "plan_id": "30f937fd-1cf1-4673-a8fe-ca9dd0259c25"
  }'

# 2. ุจุฏุก ุนูููุฉ ุงูุฏูุน
curl -X POST http://localhost:3000/api/payment/subscription/initiate \
  -H "Content-Type: application/json" \
  -d '{
    "store_id": "STORE_ID_FROM_STEP_1",
    "plan_id": "30f937fd-1cf1-4673-a8fe-ca9dd0259c25"
  }'

# 3. ูุญุงูุงุฉ webhook ุงูุฏูุน ุงููุงุฌุญ
curl -X POST http://localhost:3000/api/payment/subscription/webhook \
  -H "Content-Type: application/json" \
  -H "x-kashier-signature: SIGNATURE_HERE" \
  -d '{
    "event_type": "payment.success",
    "data": {
      "order_id": "ORDER_ID",
      "transaction_id": "TXN_ID",
      "status": "CAPTURED",
      "amount": 5
    }
  }'
```

---

## โ ูุงุฆูุฉ ุงููุญุต ุงูููุงุฆูุฉ

ูุจู ุงูุฅุทูุงู ุนูู ุงูุฅูุชุงุฌ:

- [ ] ุงุฎุชุจุงุฑ ุงูุฏูุน ุงููุงุฌุญ
- [ ] ุงุฎุชุจุงุฑ ุงูุฏูุน ุงููุฑููุถ
- [ ] ุงุฎุชุจุงุฑ ุงูุฏูุน ุงููุนูู (ุงูุญุงูุฉ ุงูุญุฑุฌุฉ!)
- [ ] ุงุฎุชุจุงุฑ ุชุฃุฎุฑ webhook
- [ ] ุงุฎุชุจุงุฑ ุงูุงุดุชุฑุงู ุงููุฌุงูู
- [ ] ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุนุฏ ูู ุงุฎุชุจุงุฑ
- [ ] ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก ูู console
- [ ] ุงูุชุญูู ูู logs ูู dashboard
- [ ] ุงุฎุชุจุงุฑ ุนูู ุฌูุงุฒ ุขุฎุฑ (ูุฅุฒุงูุฉ cache)
- [ ] ุงุฎุชุจุงุฑ ุนูู ูุชุตูุญ ูุฎุชูู

---

## ๐ ุชูุงุฑูุฑ ุงููุดุงูู

ุฅุฐุง ูุงุฌูุช ูุดููุฉ:

1. **ุงูุฑุณุงูุฉ ูุง ุชุชุญุฏุซ ูู "ุฌุงุฑู ุงููุนุงูุฌุฉ" ุฅูู "ุชู ุงููุฌุงุญ"**
   - ุชุญูู ูู logs: `console.log("[Subscription Webhook]")`
   - ุชุญูู ูู webhook ูุตู ูุนูุงู
   - ุชุญูู ูู `KASHIER_WEBHOOK_SECRET`

2. **ุฎุทุฃ "Subscription not found"**
   - ุชุญูู ูู `store_id` ู `orderId` ุตุญูุญูู
   - ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ูู ุงูุงุดุชุฑุงู ููุฌูุฏุ

3. **ุงูุฃุฒุฑุงุฑ ูุง ุชุธูุฑ**
   - ุชุญูู ูู ุญุงูุฉ `paymentStatus = "success"`
   - ุชุญูู ูู `store` ูุญูู ุงูุจูุงูุงุช ุงูุตุญูุญุฉ

---

**ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: โ ุงููุธุงู ุขูู ุชูุงูุงู ุจุนุฏ ูุฐู ุงูุชุตุญูุญุงุช!**
